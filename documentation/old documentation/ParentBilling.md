# Parent Billing Portal: Technical & Functional Specification

This document details the extension of the Parent Portal to include billing visibility and online payment capabilities for parents.

---

## 1. Overview
The Parent Billing Portal provides parents with a transparent view of their financial relationship with the clinic. It allows them to view monthly statements, track session costs, and pay outstanding balances securely online.

---

## 2. User Stories

### Parent Stories
- **PB-S1:** As a Parent, I want to see my current outstanding balance on the portal dashboard so I know if a payment is due.
- **PB-S2:** As a Parent, I want to view a detailed breakdown of a specific month's sessions and their associated costs.
- **PB-S3:** As a Parent, I want to pay my monthly invoice online using a credit card or digital wallet (Stripe/PayPal).
- **PB-S4:** As a Parent, I want to download a PDF receipt of my past payments for my own records.
- **PB-S5:** As a Parent, I want to see if my child is on a subscription plan and when the next auto-charge will occur.

---

## 3. UI & UX Design

### Portal Navigation
- **New Tab:** Add a "Billing" icon to the bottom navigation (mobile) and sidebar (desktop).
- **Dashboard Widget:** Add a "Balance Due" card to the main Parent Dashboard for immediate visibility.

### Screen Layout: `/parent/billing`
1.  **Balance Summary (Top):**
    - Large "Amount Due" display.
    - "Pay Now" primary action button.
    - Status badge (e.g., "Up to Date" or "Payment Overdue").

2.  **Monthly Statements (List):**
    - A chronological list of months (e.g., "February 2026", "January 2026").
    - Each item shows: `Total Amount | Status (Paid/Unpaid) | Download PDF`.
    - Clicking a month expands to show session-by-session line items.

3.  **Payment History:**
    - A simple table of past transactions with dates, amounts, and reference numbers.

### UX Principles
- **Clarity over Complexity:** Use plain language (e.g., "Total for February" instead of "Aggregated Monthly Debit").
- **Trust:** Display secure payment badges (Stripe/SSL) prominently.
- **Frictionless:** "Pay Now" should pre-fill the amount and take the parent directly to a secure checkout.

---

## 4. Technical Implementation

### Data Schema Enhancements (Firestore)

#### `clients/{clientId}` (Additions)
```typescript
{
  "currentBalance": 450.00,
  "paymentStatus": "pending", // 'up-to-date', 'pending', 'overdue'
  "stripeCustomerId": "cus_abc123" // For integrated payments
}
```

#### `invoices` Collection (New)
*Note: Invoices should be generated by the Admin system but made readable to the parent.*
```typescript
{
  "id": "inv_2026_02_alex",
  "clientId": "test-child-id",
  "month": 1, // 0-indexed
  "year": 2026,
  "amount": 1200.00,
  "status": "unpaid",
  "items": [
    { "date": "2026-02-01", "type": "ABA Session", "cost": 195.00 },
    // ... more items
  ]
}
```

### Payment Integration
- **Provider:** Recommended integration with **Stripe Checkout**.
- **Workflow:** 
    1. Parent clicks "Pay Now".
    2. Frontend calls a Cloud Function to create a Stripe Session.
    3. Parent is redirected to Stripe's secure page.
    4. Upon success, a Stripe Webhook updates the Firestore `invoice` status to `paid` and decrements `client.currentBalance`.

---

## 6. Security & Session Continuity
As the portal uses `localStorage` for session management, we must ensure continuity after external redirects (like Stripe).

- **Success Redirect:** The Stripe success URL should include the client code as a parameter: `.../parent/dashboard/?code=DEMO123&session=success`.
- **Re-Initialization:** Upon landing, the `ParentLoginPage` logic will detect the code and re-establish the `localStorage` session if it was cleared by the browser during redirect.
- **Anonymous Auth:** (Future) Transition to Firebase Anonymous Authentication to provide a real JWT token for the session, allowing for even tighter Firestore security rules on billing data.

---

## 5. Implementation Roadmap
1.  **Phase 1:** Update `ParentLayout` to include the "Billing" navigation item.
2.  **Phase 2:** Create the `src/app/parent/billing/page.tsx` with a read-only view of the current balance and monthly totals.
3.  **Phase 3:** Integrate the session-breakdown logic from the Admin billing module.
4.  **Phase 4:** Connect Stripe/PayPal for live payment processing.
