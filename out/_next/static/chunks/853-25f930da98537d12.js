"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[853],{76853:function(e,t,n){n.r(t),n.d(t,{NotificationProvider:function(){return u},useNotifications:function(){return d}});var i=n(3827),o=n(64090),r=n(58121),a=n(76079),l=n(1221),s=n(7944);let c=(0,o.createContext)(void 0);function u(e){let{children:t}=e,{user:n,role:u}=(0,s.q)(),[d,g]=(0,o.useState)([]),[f,v]=(0,o.useState)(0),[h,m]=(0,o.useState)(!0),[p,w]=(0,o.useState)(null),[S,y]=(0,o.useState)(null),[k,A]=(0,o.useState)(!0),[I,b]=(0,o.useState)(null),[C,N]=(0,o.useState)(!1),[_,E]=(0,o.useState)("default"),P=(0,o.useCallback)(async()=>{if(y(null),!l.Fw||!n){let e="Messaging/User missing. Msg: ".concat(!!l.Fw,", User: ").concat(!!n);console.log(e),y(e);return}try{console.log("[NotificationContext] Requesting permission...");let e=await Notification.requestPermission();if(console.log("[NotificationContext] Permission result:",e),E(e),"granted"===e){let e="BDq4Pv7vLIGjHRW3nRzz7BcJ8D3KH-4zUT3VmDM9iUANkG2tWYKBG37q8EIE3B_Mdpn6pMiVMoxPpWZnx7MlyMU";if(!e)throw Error("Missing NEXT_PUBLIC_FIREBASE_VAPID_KEY");console.log("[NotificationContext] Registering service worker manually...");let t=window.location.pathname.startsWith("/v2")?"/v2":"",i=await navigator.serviceWorker.register("".concat(t,"/firebase-messaging-sw.js"),{scope:"".concat(t,"/")});console.log("[NotificationContext] Service worker registered with scope:",i.scope),console.log("[NotificationContext] Getting token...");let o=await (0,a.LP)(l.Fw,{vapidKey:e,serviceWorkerRegistration:i});console.log("[NotificationContext] Token retrieved:",o?"Yes (hidden)":"No"),o?(console.log("[NotificationContext] Saving token to Firestore for user:",n.uid),await (0,r.pl)((0,r.JU)(l.db,"fcm_tokens",n.uid),{token:o,userId:n.uid,updatedAt:r.EK.now(),platform:"web",userAgent:navigator.userAgent},{merge:!0}),console.log("FCM Token generated and saved"),y(null)):y("No token received from FCM")}}catch(e){console.error("An error occurred while retrieving token. ",e),y(e.message||"Unknown error getting token")}},[n]);(0,o.useEffect)(()=>{"Notification"in window&&(console.log("[NotificationContext] Initial permission status:",Notification.permission),E(Notification.permission),"granted"===Notification.permission&&n&&P())},[n,P]),(0,o.useEffect)(()=>{if(!l.Fw)return;let e=(0,a.ps)(l.Fw,e=>{if(console.log("[NotificationContext] Foreground message received:",e),"granted"===Notification.permission){var t,n;let i=e.data||{};new Notification(i.title||(null===(t=e.notification)||void 0===t?void 0:t.title)||"New Message",{body:i.body||(null===(n=e.notification)||void 0===n?void 0:n.body),icon:"/icons/icon-192.svg"})}});return()=>e()},[]),(0,o.useEffect)(()=>{if(!n){v(0);return}let e=(0,r.IO)((0,r.hJ)(l.db,"threads"),(0,r.ar)("participants","array-contains",n.uid)),t=(0,r.cf)(e,e=>{let t=0;e.forEach(e=>{let i=e.data();i.lastMessage&&!i.lastMessage.readBy.includes(n.uid)&&t++}),v(t)},e=>{console.error("Error listening to threads:",e)});return()=>t()},[n]),(0,o.useEffect)(()=>{if(!n){g([]),m(!1);return}m(!0);let e=(0,r.IO)((0,r.hJ)(l.db,"notifications"),(0,r.ar)("recipientId","==",n.uid),(0,r.Xo)("createdAt","desc"),(0,r.b9)(20)),t=(0,r.cf)(e,e=>{let t=e.docs.map(e=>{var t,n,i;return{id:e.id,...e.data(),createdAt:(null===(i=e.data().createdAt)||void 0===i?void 0:null===(n=i.toDate)||void 0===n?void 0:null===(t=n.call(i))||void 0===t?void 0:t.toISOString())||e.data().createdAt}});"Admin"!==u&&(t=t.filter(e=>"billing"!==e.category)),g(t),m(!1),w(null),A(20===e.docs.length),b(e.docs[e.docs.length-1]||null)},e=>{console.error("Error fetching notifications:",e),w(e.message),m(!1)});return()=>t()},[n,u]);let x=(0,o.useMemo)(()=>d.filter(e=>!e.read).length,[d]),M=(0,o.useCallback)(async e=>{await (0,r.r7)((0,r.JU)(l.db,"notifications",e),{read:!0,readAt:r.EK.now()})},[]),U=(0,o.useCallback)(async()=>{let e=d.filter(e=>!e.read);await Promise.all(e.map(e=>(0,r.r7)((0,r.JU)(l.db,"notifications",e.id),{read:!0,readAt:r.EK.now()})))},[d]),D=(0,o.useCallback)(e=>"all"===e?d:"unread"===e?d.filter(e=>!e.read):d.filter(t=>t.category===e),[d]),F=(0,o.useCallback)(e=>"all"===e?d.length:"unread"===e?d.filter(e=>!e.read).length:d.filter(t=>t.category===e).length,[d]),B=(0,o.useCallback)(e=>{let t=e||d,n=new Date,i=new Date(n.getFullYear(),n.getMonth(),n.getDate()),o=new Date(i.getTime()-864e5),r=new Date(i.getTime()-6048e5),a={today:[],yesterday:[],thisWeek:[],older:[]};return t.forEach(e=>{let t=new Date(e.createdAt);t>=i?a.today.push(e):t>=o?a.yesterday.push(e):t>=r?a.thisWeek.push(e):a.older.push(e)}),a},[d]),J=(0,o.useCallback)(async()=>{if(!n||!I||!k)return;let e=(0,r.IO)((0,r.hJ)(l.db,"notifications"),(0,r.ar)("recipientId","==",n.uid),(0,r.Xo)("createdAt","desc"),(0,r.TQ)(I),(0,r.b9)(20)),t=await (0,r.PL)(e),i=t.docs.map(e=>{var t,n,i;return{id:e.id,...e.data(),createdAt:(null===(i=e.data().createdAt)||void 0===i?void 0:null===(n=i.toDate)||void 0===n?void 0:null===(t=n.call(i))||void 0===t?void 0:t.toISOString())||e.data().createdAt}});"Admin"!==u&&(i=i.filter(e=>"billing"!==e.category)),g(e=>[...e,...i]),A(20===t.docs.length),b(t.docs[t.docs.length-1]||null)},[n,I,k,u]);return(0,i.jsx)(c.Provider,{value:{notifications:d,unreadCount:x,unreadMessageCount:f,loading:h,error:p,markAsRead:M,markAllAsRead:U,loadMore:J,hasMore:k,isDropdownOpen:C,setDropdownOpen:N,filterByCategory:D,getGroupedNotifications:B,getCategoryCount:F,requestPushPermission:P,pushPermissionStatus:_,pushError:S},children:t})}function d(){let e=(0,o.useContext)(c);if(!e)throw Error("useNotifications must be used within NotificationProvider");return e}},10207:function(e,t,n){n.d(t,{Sp:function(){return u},gx:function(){return c}});var i=n(3827),o=n(64090),r=n(27065),a=n(1221),l=n(58121);let s=(0,o.createContext)(void 0);function c(e){let{children:t}=e,[n,c]=(0,o.useState)(null),[u,d]=(0,o.useState)(null),[g,f]=(0,o.useState)(null),[v,h]=(0,o.useState)(!0);(0,o.useEffect)(()=>{let e=(0,r.Aj)(a.I8,async e=>{if(null==e?void 0:e.isAnonymous){c(e);let t=localStorage.getItem("parent_client_id"),n=localStorage.getItem("parent_client_name"),i=localStorage.getItem("parent_uid");t&&i===e.uid?(d(t),f(n)):(d(null),f(null))}else c(null),d(null),f(null);h(!1)});return()=>e()},[]);let m=(0,o.useCallback)(async(e,t)=>{try{let n=a.I8.currentUser;n&&n.isAnonymous||(n=(await (0,r.XB)(a.I8)).user);let i=(0,l.JU)(a.db,"clients",e);await (0,l.r7)(i,{parentUids:(0,l.vr)(n.uid)}),localStorage.setItem("parent_uid",n.uid),localStorage.setItem("parent_client_id",e),localStorage.setItem("parent_client_name",t),c(n),d(e),f(t),console.log("[ParentAuth] Successfully authenticated parent with UID:",n.uid)}catch(e){throw console.error("[ParentAuth] Error authenticating:",e),e}},[]),p=(0,o.useCallback)(async()=>{try{localStorage.removeItem("parent_uid"),localStorage.removeItem("parent_client_id"),localStorage.removeItem("parent_client_name"),localStorage.removeItem("parent_client_code"),await (0,r.w7)(a.I8),c(null),d(null),f(null)}catch(e){console.error("[ParentAuth] Error signing out:",e)}},[]);return(0,i.jsx)(s.Provider,{value:{user:n,clientId:u,clientName:g,loading:v,isAuthenticated:null!==n&&null!==u,authenticateWithCode:m,signOut:p},children:t})}function u(){return(0,o.useContext)(s)}},7944:function(e,t,n){n.d(t,{q:function(){return r}});var i=n(18628),o=n(10207);function r(){let e=(0,i.useAuth)(),t=(0,o.Sp)();return(null==e?void 0:e.user)&&!e.loading?{user:e.user,isParent:!1,isStaff:!0,loading:!1,role:e.userRole}:(null==t?void 0:t.user)&&t.isAuthenticated&&!t.loading?{user:t.user,isParent:!0,isStaff:!1,loading:!1,role:"Parent"}:{user:null,isParent:!1,isStaff:!1,loading:(null==e?void 0:e.loading)||(null==t?void 0:t.loading)||!1,role:null}}}}]);