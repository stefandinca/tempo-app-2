"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6853],{76853:function(e,t,n){n.r(t),n.d(t,{NotificationProvider:function(){return d},useNotifications:function(){return g}});var o=n(3827),r=n(64090),i=n(58121),a=n(76079),l=n(1221),s=n(7944),u=n(12535);let c=(0,r.createContext)(void 0);function d(e){let{children:t}=e,{t:n}=(0,u.$G)(),{user:d,role:g}=(0,s.q)(),[f,h]=(0,r.useState)([]),[v,m]=(0,r.useState)(0),[p,w]=(0,r.useState)(!0),[S,A]=(0,r.useState)(null),[I,y]=(0,r.useState)(null),[_,P]=(0,r.useState)(!0),[k,C]=(0,r.useState)(null),[b,E]=(0,r.useState)(!1),[N,x]=(0,r.useState)("default"),U=(0,r.useCallback)(async()=>{if(y(null),!l.Fw||!d){let e="Messaging/User missing. Msg: ".concat(!!l.Fw,", User: ").concat(!!d);console.log(e),y(e);return}try{console.log("[NotificationContext] Requesting permission...");let e=await Notification.requestPermission();if(console.log("[NotificationContext] Permission result:",e),x(e),"granted"===e){let e="BDq4Pv7vLIGjHRW3nRzz7BcJ8D3KH-4zUT3VmDM9iUANkG2tWYKBG37q8EIE3B_Mdpn6pMiVMoxPpWZnx7MlyMU";if(!e)throw Error("Missing NEXT_PUBLIC_FIREBASE_VAPID_KEY");console.log("[NotificationContext] Registering service worker manually...");let t=window.location.pathname.startsWith("/v2")?"/v2":"",n=await navigator.serviceWorker.register("".concat(t,"/firebase-messaging-sw.js"),{scope:"".concat(t,"/")});console.log("[NotificationContext] Service worker registered with scope:",n.scope),console.log("[NotificationContext] Getting token...");let o=await (0,a.LP)(l.Fw,{vapidKey:e,serviceWorkerRegistration:n});console.log("[NotificationContext] Token retrieved:",o?"Yes (hidden)":"No"),o?(console.log("[NotificationContext] Saving token to Firestore for user:",d.uid),await (0,i.pl)((0,i.JU)(l.db,"fcm_tokens",d.uid),{token:o,userId:d.uid,updatedAt:i.EK.now(),platform:"web",userAgent:navigator.userAgent},{merge:!0}),console.log("FCM Token generated and saved"),y(null)):y("No token received from FCM")}}catch(e){console.error("An error occurred while retrieving token. ",e),y(e.message||"Unknown error getting token")}},[d]);(0,r.useEffect)(()=>{"Notification"in window&&(console.log("[NotificationContext] Initial permission status:",Notification.permission),x(Notification.permission),"granted"===Notification.permission&&d&&U())},[d,U]),(0,r.useEffect)(()=>{if(!l.Fw)return;let e=(0,a.ps)(l.Fw,e=>{console.log("[NotificationContext] Foreground message received:",e)});return()=>e()},[]),(0,r.useEffect)(()=>{if(!d){m(0);return}let e=(0,i.IO)((0,i.hJ)(l.db,"threads"),(0,i.ar)("participants","array-contains",d.uid)),t=(0,i.cf)(e,e=>{let t=0;e.forEach(e=>{let n=e.data();n.lastMessage&&!n.lastMessage.readBy.includes(d.uid)&&t++}),m(t)},e=>{console.error("Error listening to threads:",e)});return()=>t()},[d]),(0,r.useEffect)(()=>{if(!d){h([]),w(!1);return}w(!0);let e=(0,i.IO)((0,i.hJ)(l.db,"notifications"),(0,i.ar)("recipientId","==",d.uid),(0,i.Xo)("createdAt","desc"),(0,i.b9)(20)),t=(0,i.cf)(e,e=>{let t=e.docs.map(e=>{var t,n,o;return{id:e.id,...e.data(),createdAt:(null===(o=e.data().createdAt)||void 0===o?void 0:null===(n=o.toDate)||void 0===n?void 0:null===(t=n.call(o))||void 0===t?void 0:t.toISOString())||e.data().createdAt}});"Admin"!==g&&(t=t.filter(e=>"billing"!==e.category)),h(t),w(!1),A(null),P(20===e.docs.length),C(e.docs[e.docs.length-1]||null)},e=>{console.error("Error fetching notifications:",e),A(e.message),w(!1)});return()=>t()},[d,g]);let D=(0,r.useMemo)(()=>f.filter(e=>!e.read).length,[f]),M=(0,r.useCallback)(async e=>{await (0,i.r7)((0,i.JU)(l.db,"notifications",e),{read:!0,readAt:i.EK.now()})},[]),F=(0,r.useCallback)(async()=>{let e=f.filter(e=>!e.read);await Promise.all(e.map(e=>(0,i.r7)((0,i.JU)(l.db,"notifications",e.id),{read:!0,readAt:i.EK.now()})))},[f]),R=(0,r.useCallback)(e=>"all"===e?f:"unread"===e?f.filter(e=>!e.read):f.filter(t=>t.category===e),[f]),B=(0,r.useCallback)(e=>"all"===e?f.length:"unread"===e?f.filter(e=>!e.read).length:f.filter(t=>t.category===e).length,[f]),J=(0,r.useCallback)(e=>{let t=e||f,n=new Date,o=new Date(n.getFullYear(),n.getMonth(),n.getDate()),r=new Date(o.getTime()-864e5),i=new Date(o.getTime()-6048e5),a={today:[],yesterday:[],thisWeek:[],older:[]};return t.forEach(e=>{let t=new Date(e.createdAt);t>=o?a.today.push(e):t>=r?a.yesterday.push(e):t>=i?a.thisWeek.push(e):a.older.push(e)}),a},[f]),T=(0,r.useCallback)(async()=>{if(!d||!k||!_)return;let e=(0,i.IO)((0,i.hJ)(l.db,"notifications"),(0,i.ar)("recipientId","==",d.uid),(0,i.Xo)("createdAt","desc"),(0,i.TQ)(k),(0,i.b9)(20)),t=await (0,i.PL)(e),n=t.docs.map(e=>{var t,n,o;return{id:e.id,...e.data(),createdAt:(null===(o=e.data().createdAt)||void 0===o?void 0:null===(n=o.toDate)||void 0===n?void 0:null===(t=n.call(o))||void 0===t?void 0:t.toISOString())||e.data().createdAt}});"Admin"!==g&&(n=n.filter(e=>"billing"!==e.category)),h(e=>[...e,...n]),P(20===t.docs.length),C(t.docs[t.docs.length-1]||null)},[d,k,_,g]);return(0,o.jsx)(c.Provider,{value:{notifications:f,unreadCount:D,unreadMessageCount:v,loading:p,error:S,markAsRead:M,markAllAsRead:F,loadMore:T,hasMore:_,isDropdownOpen:b,setDropdownOpen:E,filterByCategory:R,getGroupedNotifications:J,getCategoryCount:B,requestPushPermission:U,pushPermissionStatus:N,pushError:I},children:t})}function g(){let e=(0,r.useContext)(c);if(!e)throw Error("useNotifications must be used within NotificationProvider");return e}},10207:function(e,t,n){n.d(t,{Sp:function(){return d},gx:function(){return u},jT:function(){return c}});var o=n(3827),r=n(64090),i=n(27065),a=n(1221),l=n(58121);let s=(0,r.createContext)(void 0);function u(e){let{children:t}=e,[n,u]=(0,r.useState)(null),[c,d]=(0,r.useState)(null),[g,f]=(0,r.useState)(null),[h,v]=(0,r.useState)(!0);(0,r.useEffect)(()=>{let e=(0,i.Aj)(a.I8,async e=>{if(null==e?void 0:e.isAnonymous){u(e);let t=localStorage.getItem("parent_client_id"),n=localStorage.getItem("parent_client_name"),o=localStorage.getItem("parent_uid");if(t){if(o!==e.uid){console.log("[ParentAuth] UID mismatch or new session. Re-registering with client...");try{let n=(0,l.JU)(a.db,"clients",t);await (0,l.r7)(n,{parentUids:(0,l.vr)(e.uid)}),console.log("[ParentAuth] Re-registered successfully."),localStorage.setItem("parent_uid",e.uid)}catch(e){console.error("[ParentAuth] Failed to re-register UID with client:",e)}}d(t),f(n)}else d(null),f(null);v(!1)}else if(localStorage.getItem("parent_client_code")&&!e){console.log("[ParentAuth] No active session, but found stored code. Auto-logging in...");try{await (0,i.XB)(a.I8);return}catch(e){console.error("[ParentAuth] Auto-login failed:",e),v(!1)}}else u(null),d(null),f(null),v(!1)});return()=>e()},[]);let m=(0,r.useCallback)(async(e,t,n)=>{try{let o=a.I8.currentUser;o&&o.isAnonymous||(o=(await (0,i.XB)(a.I8)).user);let r=(0,l.JU)(a.db,"clients",e);await (0,l.r7)(r,{parentUids:(0,l.vr)(o.uid)}),localStorage.setItem("parent_uid",o.uid),localStorage.setItem("parent_client_id",e),localStorage.setItem("parent_client_name",t),localStorage.setItem("parent_client_code",n.toUpperCase()),u(o),d(e),f(t),console.log("[ParentAuth] Successfully authenticated parent with UID:",o.uid)}catch(e){throw console.error("[ParentAuth] Error authenticating:",e),e}},[]),p=(0,r.useCallback)(async()=>{try{localStorage.removeItem("parent_uid"),localStorage.removeItem("parent_client_id"),localStorage.removeItem("parent_client_name"),localStorage.removeItem("parent_client_code"),await (0,i.w7)(a.I8),u(null),d(null),f(null)}catch(e){console.error("[ParentAuth] Error signing out:",e)}},[]);return(0,o.jsx)(s.Provider,{value:{user:n,clientId:c,clientName:g,loading:h,isAuthenticated:null!==n&&null!==c,authenticateWithCode:m,signOut:p},children:t})}function c(){let e=(0,r.useContext)(s);if(void 0===e)throw Error("useParentAuth must be used within ParentAuthProvider");return e}function d(){return(0,r.useContext)(s)}},7944:function(e,t,n){n.d(t,{q:function(){return i}});var o=n(21678),r=n(10207);function i(){var e,t;let n=(0,r.Sp)(),i=(0,o.useAuth)();if((null==n?void 0:n.user)&&n.isAuthenticated)return{user:n.user,isParent:!0,isStaff:!1,loading:n.loading,role:"Parent"};if((null==i?void 0:i.user)&&i.userRole)return{user:i.user,isParent:!1,isStaff:!0,loading:i.loading,role:i.userRole};if(null==i?void 0:null===(e=i.user)||void 0===e?void 0:e.isAnonymous)return{user:i.user,isParent:!0,isStaff:!1,loading:i.loading,role:"Parent"};let a=(null==i?void 0:i.loading)||null!==(t=null==n?void 0:n.loading)&&void 0!==t&&t;return{user:(null==i?void 0:i.user)||(null==n?void 0:n.user)||null,isParent:!1,isStaff:!1,loading:a,role:null}}}}]);