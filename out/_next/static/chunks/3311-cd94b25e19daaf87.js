"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3311],{10207:function(e,t,n){n.d(t,{Sp:function(){return c},gx:function(){return d},jT:function(){return s}});var i=n(3827),a=n(64090),r=n(27065),l=n(1221),o=n(58121);let u=(0,a.createContext)(void 0);function d(e){let{children:t}=e,[n,d]=(0,a.useState)(null),[s,c]=(0,a.useState)(null),[f,h]=(0,a.useState)(null),[p,v]=(0,a.useState)(!0);(0,a.useEffect)(()=>{let e=(0,r.Aj)(l.I8,async e=>{if(null==e?void 0:e.isAnonymous){d(e);let t=localStorage.getItem("parent_client_id"),n=localStorage.getItem("parent_client_name"),i=localStorage.getItem("parent_uid");if(t){if(i!==e.uid){console.log("[ParentAuth] UID mismatch or new session. Re-registering with client...");try{let n=(0,o.JU)(l.db,"clients",t);await (0,o.r7)(n,{parentUids:(0,o.vr)(e.uid)}),console.log("[ParentAuth] Re-registered successfully."),localStorage.setItem("parent_uid",e.uid)}catch(e){console.error("[ParentAuth] Failed to re-register UID with client:",e)}}c(t),h(n)}else c(null),h(null);v(!1)}else if(localStorage.getItem("parent_client_code")&&!e){console.log("[ParentAuth] No active session, but found stored code. Auto-logging in...");try{await (0,r.XB)(l.I8);return}catch(e){console.error("[ParentAuth] Auto-login failed:",e),v(!1)}}else d(null),c(null),h(null),v(!1)});return()=>e()},[]);let m=(0,a.useCallback)(async(e,t,n)=>{try{let i=l.I8.currentUser;i&&i.isAnonymous||(i=(await (0,r.XB)(l.I8)).user);let a=(0,o.JU)(l.db,"clients",e);await (0,o.r7)(a,{parentUids:(0,o.vr)(i.uid)}),localStorage.setItem("parent_uid",i.uid),localStorage.setItem("parent_client_id",e),localStorage.setItem("parent_client_name",t),localStorage.setItem("parent_client_code",n.toUpperCase()),d(i),c(e),h(t),console.log("[ParentAuth] Successfully authenticated parent with UID:",i.uid)}catch(e){throw console.error("[ParentAuth] Error authenticating:",e),e}},[]),g=(0,a.useCallback)(async()=>{try{localStorage.removeItem("parent_uid"),localStorage.removeItem("parent_client_id"),localStorage.removeItem("parent_client_name"),localStorage.removeItem("parent_client_code"),await (0,r.w7)(l.I8),d(null),c(null),h(null)}catch(e){console.error("[ParentAuth] Error signing out:",e)}},[]);return(0,i.jsx)(u.Provider,{value:{user:n,clientId:s,clientName:f,loading:p,isAuthenticated:null!==n&&null!==s,authenticateWithCode:m,signOut:g},children:t})}function s(){let e=(0,a.useContext)(u);if(void 0===e)throw Error("useParentAuth must be used within ParentAuthProvider");return e}function c(){return(0,a.useContext)(u)}},7944:function(e,t,n){n.d(t,{q:function(){return r}});var i=n(21678),a=n(10207);function r(){var e,t;let n=(0,a.Sp)(),r=(0,i.useAuth)();if((null==n?void 0:n.user)&&n.isAuthenticated)return{user:n.user,isParent:!0,isStaff:!1,loading:n.loading,role:"Parent"};if((null==r?void 0:r.user)&&r.userRole)return{user:r.user,isParent:!1,isStaff:!0,loading:r.loading,role:r.userRole};if(null==r?void 0:null===(e=r.user)||void 0===e?void 0:e.isAnonymous)return{user:r.user,isParent:!0,isStaff:!1,loading:r.loading,role:"Parent"};let l=(null==r?void 0:r.loading)||null!==(t=null==n?void 0:n.loading)&&void 0!==t&&t;return{user:(null==r?void 0:r.user)||(null==n?void 0:n.user)||null,isParent:!1,isStaff:!1,loading:l,role:null}}},53311:function(e,t,n){n.d(t,{KR:function(){return c},qi:function(){return h},y_:function(){return f}});var i=n(64090),a=n(58121),r=n(1221),l=n(7944),o=n(21678),u=n(10207),d=n(73719),s=n(12228);function c(){let{user:e}=(0,l.q)(),[t,n]=(0,i.useState)([]),[o,u]=(0,i.useState)(!0);return(0,i.useEffect)(()=>{if(!e){u(!1);return}let t=(0,a.IO)((0,a.hJ)(r.db,"threads"),(0,a.ar)("participants","array-contains",e.uid),(0,a.Xo)("updatedAt","desc")),i=(0,a.cf)(t,t=>{let i=[];t.forEach(t=>{var n;let a=t.data();(null===(n=a.archivedBy)||void 0===n?void 0:n.includes(e.uid))||i.push({...a,id:t.id})}),n(i),u(!1)});return()=>i()},[e]),{threads:t,loading:o}}function f(e){let[t,n]=(0,i.useState)([]),[l,o]=(0,i.useState)(!1);return(0,i.useEffect)(()=>{if(!e){n([]);return}o(!0);let t=(0,a.IO)((0,a.hJ)(r.db,"threads",e,"messages"),(0,a.Xo)("timestamp","asc")),i=(0,a.cf)(t,e=>{let t=[];e.forEach(e=>{t.push({id:e.id,...e.data()})}),n(t),o(!1)});return()=>i()},[e]),{messages:t,loading:l}}function h(){let{user:e,isParent:t,role:n}=(0,l.q)(),i=(0,o.useAuth)(),c=(0,u.Sp)(),{data:f}=(0,d.m)((null==c?void 0:c.clientId)||"");return{sendMessage:async(n,l)=>{if(!e||!l.trim())return;let o={senderId:e.uid,text:l.trim(),timestamp:(0,a.Bt)(),type:"text"};await (0,a.ET)((0,a.hJ)(r.db,"threads",n,"messages"),o),await (0,a.r7)((0,a.JU)(r.db,"threads",n),{lastMessage:{text:l.trim(),senderId:e.uid,timestamp:(0,a.Bt)(),readBy:[e.uid]},updatedAt:(0,a.Bt)(),archivedBy:[]});try{let o=await (0,a.QT)((0,a.JU)(r.db,"threads",n));if(o.exists()){let a=o.data(),r=a.participants.find(t=>t!==e.uid),d=r?a.participantDetails[r]:null;if(r&&d){let o="Someone";if(t){let t=a.participantDetails[e.uid];o=(null==t?void 0:t.name)||((null==c?void 0:c.clientName)?"Parent of ".concat(c.clientName):"Parent")}else{var u;let t=a.participantDetails[e.uid];o=(null==t?void 0:t.name)||(null==i?void 0:null===(u=i.userData)||void 0===u?void 0:u.name)||"Staff Member"}await (0,s.uD)(r,d.role.toLowerCase(),{senderName:o,text:l.trim(),threadId:n,triggeredByUserId:e.uid})}}}catch(e){console.error("[useChat] Error sending notification:",e)}},createOrGetThread:async l=>{let o;if(!e)return null;let u=(0,a.IO)((0,a.hJ)(r.db,"threads"),(0,a.ar)("participants","array-contains",e.uid),(0,a.Xo)("updatedAt","desc")),d=await (0,a.PL)(u),s=null;if(d.forEach(e=>{let t=e.data();t.participants.includes(l.id)&&(!t.archivedBy||0===t.archivedBy.length)&&(s=e.id)}),s){var h;let o=null===(h=d.docs.find(e=>e.id===s))||void 0===h?void 0:h.data(),u=null==o?void 0:o.participantDetails[e.uid],p=null==o?void 0:o.participantDetails[l.id];if(!l.phone||(null==p?void 0:p.phone)&&(null==p?void 0:p.clientId)||await (0,a.r7)((0,a.JU)(r.db,"threads",s),{["participantDetails.".concat(l.id,".phone")]:l.phone,["participantDetails.".concat(l.id,".clientId")]:l.clientId||(null==p?void 0:p.clientId)||""}),!u||"Unknown"===u.name||"Staff Member"===u.name||t&&"Parent"===u.name||!u.phone){let l;if(t)l={id:e.uid,name:(null==c?void 0:c.clientName)?"Parent of ".concat(c.clientName):"Parent",initials:"P",color:"#4A90E2",role:"Parent",phone:(null==f?void 0:f.phone)||"",clientId:(null==c?void 0:c.clientId)||""};else{let t=null==i?void 0:i.userData;l={id:e.uid,name:(null==t?void 0:t.name)||"Staff Member",initials:(null==t?void 0:t.initials)||"S",color:(null==t?void 0:t.color)||"#ccc",role:n||"Staff",phone:(null==t?void 0:t.phone)||""}}await (0,a.r7)((0,a.JU)(r.db,"threads",s),{["participantDetails.".concat(e.uid)]:l})}return s}let p=(0,a.JU)((0,a.hJ)(r.db,"threads")),v=p.id;if(t)o={id:e.uid,name:(null==c?void 0:c.clientName)?"Parent of ".concat(c.clientName):"Parent",initials:"P",color:"#4A90E2",role:"Parent",phone:(null==f?void 0:f.phone)||"",clientId:(null==c?void 0:c.clientId)||""};else{let t=null==i?void 0:i.userData;o={id:e.uid,name:(null==t?void 0:t.name)||"Staff Member",initials:(null==t?void 0:t.initials)||"S",color:(null==t?void 0:t.color)||"#ccc",role:n||"Staff",phone:(null==t?void 0:t.phone)||""}}return await (0,a.pl)(p,{participants:[e.uid,l.id],participantDetails:{[e.uid]:o,[l.id]:l},createdAt:(0,a.Bt)(),updatedAt:(0,a.Bt)(),archivedBy:[]}),v},markAsRead:async t=>{e&&await (0,a.r7)((0,a.JU)(r.db,"threads",t),{"lastMessage.readBy":(0,a.vr)(e.uid)})},archiveThread:async t=>{e&&await (0,a.r7)((0,a.JU)(r.db,"threads",t),{archivedBy:(0,a.vr)(e.uid)})}}}},73719:function(e,t,n){n.d(t,{m:function(){return l}});var i=n(64090),a=n(58121),r=n(1221);function l(e){let[t,n]=(0,i.useState)(null),[l,o]=(0,i.useState)(!0),[u,d]=(0,i.useState)(null);return(0,i.useEffect)(()=>{if(!e)return;o(!0);let t=(0,a.cf)((0,a.JU)(r.db,"clients",e),e=>{e.exists()?n({id:e.id,...e.data()}):d("Client not found"),o(!1)},e=>{console.error("Error fetching client:",e),d(e.message),o(!1)});return()=>t()},[e]),{data:t,loading:l,error:u}}}}]);