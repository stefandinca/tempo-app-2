rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {

    // Helper: Check if user is signed in
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper: Check if user is an Admin
    function isAdmin() {
      return isSignedIn() &&
             firestore.exists(/databases/(default)/documents/team_members/$(request.auth.uid)) &&
             firestore.get(/databases/(default)/documents/team_members/$(request.auth.uid)).data.role in ['Admin', 'admin'];
    }

    // ============================================
    // AVATARS
    // Path: avatars/{userId}/{fileName}
    // ============================================
    match /avatars/{userId}/{fileName} {
      allow read: if true; // Publicly readable
      
      // Allow write if you are the owner or an admin
      // Simplified checks to reduce firestore overhead
      allow write: if isSignedIn() && (request.auth.uid == userId || isAdmin());
    }

    // Helper: Check if user is a staff member (Admin, Coordinator, or Therapist)
    function isStaff() {
      return isSignedIn() &&
             firestore.exists(/databases/(default)/documents/team_members/$(request.auth.uid));
    }

    // Helper: Check if user is a parent of the specific client
    function isClientParent(clientId) {
      return isSignedIn() &&
             firestore.exists(/databases/(default)/documents/clients/$(clientId)) &&
             request.auth.uid in firestore.get(/databases/(default)/documents/clients/$(clientId)).data.parentUids;
    }

    // ============================================
    // CLIENT DOCUMENTS
    // Path: clients/{clientId}/documents/{fileName}
    // ============================================
    match /clients/{clientId}/documents/{fileName} {
      allow read: if isAdmin() || isStaff() || isClientParent(clientId);
      allow write: if isAdmin() || isStaff();
    }

    // ============================================
    // DEFAULT: Deny all other paths
    // ============================================
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
